{% extends 'base.html' %}

{% block title %}{{ lesson.title }} - {{ site_name }}{% endblock %}

{% block content %}
<div class="container py-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'courses:course_list' %}">Courses</a></li>
            <li class="breadcrumb-item"><a href="{% url 'courses:course_detail' course_id=course.id %}">{{ course.title }}</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{ lesson.title }}</li>
        </ol>
    </nav>

    <div class="row">
        <div class="col-md-8">
            <h1>{{ lesson.title }}</h1>
            
            {% if is_enrolled or is_instructor %}
                <!-- Video Section (if available) -->
                {% if lesson.video_url %}
                    <div class="lesson-video mb-4">
                        <div class="ratio ratio-16x9">
                            <iframe src="{{ lesson.video_url }}" title="{{ lesson.title }}" allowfullscreen></iframe>
                        </div>
                    </div>
                {% endif %}
                
                <!-- Lesson Content -->
                <div class="card mb-4">
                    <div class="card-body lesson-content">
                        {{ lesson.content|linebreaks }}
                    </div>
                </div>
                
                <!-- Student Progress Actions -->
                {% if is_enrolled and not is_instructor %}
                    <div class="card mb-4">
                        <div class="card-body">
                            <h5 class="card-title">Your Progress</h5>
                            
                            {% if progress_status == 'completed' %}
                                <div class="alert alert-success">
                                    <i class="bi bi-check-circle-fill"></i> You have completed this lesson.
                                </div>
                            {% elif progress_status == 'in_progress' %}
                                <form method="post" action="{% url 'lessons:mark_lesson_complete' lesson_id=lesson.id %}">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-success">
                                        <i class="bi bi-check-circle"></i> Mark as Completed
                                    </button>
                                </form>
                            {% else %}
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle-fill"></i> You've started this lesson. When you're finished, mark it as completed.
                                </div>
                                <form method="post" action="{% url 'lessons:mark_lesson_complete' lesson_id=lesson.id %}">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-success">
                                        <i class="bi bi-check-circle"></i> Mark as Completed
                                    </button>
                                </form>
                            {% endif %}
                        </div>
                    </div>
                {% endif %}
                
                <!-- Teacher Actions -->
                {% if is_instructor %}
                    <div class="card mb-4">
                        <div class="card-body">
                            <h5 class="card-title">Instructor Actions</h5>
                            <div class="d-flex gap-2">
                                <a href="{% url 'lessons:edit_lesson' lesson_id=lesson.id %}" class="btn btn-warning">
                                    <i class="bi bi-pencil"></i> Edit Lesson
                                </a>
                                <a href="{% url 'lessons:delete_lesson' lesson_id=lesson.id %}" class="btn btn-danger">
                                    <i class="bi bi-trash"></i> Delete Lesson
                                </a>
                            </div>
                        </div>
                    </div>
                {% endif %}
            {% else %}
                <!-- Not Enrolled View -->
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle-fill"></i> You need to be enrolled in this course to view the full lesson content.
                    <a href="{% url 'courses:enroll_course' course_id=course.id %}" class="btn btn-primary ms-2">
                        Enroll Now
                    </a>
                </div>
                
                <!-- Preview (partial content) -->
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">Lesson Preview</h5>
                        <p>{{ lesson.content|truncatewords:50 }}</p>
                        <div class="text-center">
                            <a href="{% url 'courses:enroll_course' course_id=course.id %}" class="btn btn-primary">
                                <i class="bi bi-play-fill"></i> Enroll to Continue
                            </a>
                        </div>
                    </div>
                </div>
            {% endif %}
            
            <!-- Lesson Navigation -->
            <div class="lesson-navigation d-flex justify-content-between mb-4">
                {% if prev_lesson %}
                    <a href="{% url 'lessons:lesson_detail' lesson_id=prev_lesson.id %}" class="btn btn-outline-primary">
                        <i class="bi bi-arrow-left"></i> Previous Lesson
                    </a>
                {% else %}
                    <div></div>
                {% endif %}
                
                <a href="{% url 'courses:course_detail' course_id=course.id %}" class="btn btn-outline-secondary">
                    <i class="bi bi-grid"></i> Course Overview
                </a>
                
                {% if next_lesson %}
                    <a href="{% url 'lessons:lesson_detail' lesson_id=next_lesson.id %}" class="btn btn-outline-primary">
                        Next Lesson <i class="bi bi-arrow-right"></i>
                    </a>
                {% else %}
                    <div></div>
                {% endif %}
            </div>
        </div>
        
        <div class="col-md-4">
            <!-- Lesson Information -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h4 class="card-title mb-0">Lesson Information</h4>
                </div>
                <div class="card-body">
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item">
                            <strong>Course:</strong> {{ course.title }}
                        </li>
                        <li class="list-group-item">
                            <strong>Instructor:</strong> {{ course.instructor.get_full_name }}
                        </li>
                        <li class="list-group-item">
                            <strong>Last Updated:</strong> {{ lesson.updated_at|date:"F j, Y" }}
                        </li>
                    </ul>
                </div>
            </div>
            
            <!-- Course Lessons Navigation -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h4 class="card-title mb-0">Course Lessons</h4>
                </div>
                <div class="list-group list-group-flush">
                    {% for course_lesson in course.lessons.all %}
                        <a href="{% url 'lessons:lesson_detail' lesson_id=course_lesson.id %}" 
                           class="list-group-item list-group-item-action d-flex justify-content-between align-items-center {% if course_lesson.id == lesson.id %}active{% endif %}">
                            <div>
                                <h6 class="mb-0">{{ course_lesson.order }}. {{ course_lesson.title }}</h6>
                                {% if is_enrolled and not is_instructor %}
                                    {% for progress_item in lessons_progress %}
                                        {% if progress_item.lesson.id == course_lesson.id %}
                                            {% if progress_item.status == 'completed' %}
                                                <span class="badge bg-success">Completed</span>
                                            {% elif progress_item.status == 'in_progress' %}
                                                <span class="badge bg-primary">In Progress</span>
                                            {% else %}
                                                <span class="badge bg-secondary">Not Started</span>
                                            {% endif %}
                                        {% endif %}
                                    {% endfor %}
                                {% endif %}
                            </div>
                            {% if course_lesson.id == lesson.id %}
                                <i class="bi bi-arrow-right"></i>
                            {% endif %}
                        </a>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}